<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width">
<meta http-equiv="pragma" content="no-cache"> 
<meta http-equiv="Cache-Control" content="no-cache, must-revalidate"> 
<meta http-equiv="expires" content="0">
<title>kfsshrimp4噗浪備份系統</title>
<style>
body{
    background:#222;
    color: #000;
    margin: 0px;
    padding: 0px;
    text-align: center;
    font-size: 20px;
}
button{
    cursor: pointer;
}
a[href]:hover{
    color: #f00;
    transition-duration: 0.5s;
}
#FileBox{
    padding: 10px;
    margin: 10px;
}
#Info{
    margin: 10px;
    padding: 10px;
    border: 1px #fff solid;
    border-radius: 10px;
    background: #999;
    color: #000;
}
#Plurk>div{
    border: 1px #fff solid;
    margin: 10px;
    padding: 5px;
    border-radius: 10px;
    text-align: left;
    background: #999;
}
#Plurk>div a{
    width: min-content;
    display: grid;
}
#Plurk>div>div:not(.content){
    display: none;
}
#Plurk>div img{
    height: auto;
    width: auto;
}
</style>
<script>
    var JsonFile;
    window.onload = ()=>{

        for(var i=1;i<=12;i++){
            var opt = document.createElement("option");
            opt.innerText = i;
            document.querySelector("#month").appendChild(opt);
        }

        for(var i=new Date().getFullYear()-3;i<=new Date().getFullYear();i++){
            var opt = document.createElement("option");
            opt.innerText = i;
            document.querySelector("#year").appendChild(opt);
        }


        document.querySelector("#submit").addEventListener("click",()=>{

                document.querySelector("#Plurk").innerHTML = ``;

                var year = document.querySelector("#year").value;
                var month = document.querySelector("#month").value;
                
                LoadJson(`${year} ${month}.json`);

        });
        
        

        /*
        document.querySelector("#File").addEventListener("click",()=>{
            this.value = ``;
        });


        document.querySelector("#FileBox button").addEventListener("click",()=>{

            document.querySelector("#Plurk").innerHTML = ``;
            var reader = new FileReader();
            var file = document.querySelector("#File");

            reader.readAsText(file.files[0]);

            reader.onload = (r)=>{
                try{
                    console.log(( JSON.parse(r.target.result)) );

                    JsonFile = JSON.parse(r.target.result);

                    ShowPlurk( JSON.parse(r.target.result) );

                }catch(e){
                    alert("檔案錯誤");
                    return;
                }
            }

        });
        */
    }

    function ShowPlurk(){

        var plurk_html = document.createElement("div");
        plurk_html.innerHTML = `<a href="${JsonFile.url}">噗浪原網址${JsonFile.url}</a>`;
        

        document.querySelector("#Plurk").appendChild(plurk_html);


        JsonFile.plurk.forEach(plurk => {
            var plurk_html = document.createElement("div");
            plurk_html.innerHTML = plurk;
            

            document.querySelector("#Plurk").appendChild(plurk_html);
        });

        document.querySelectorAll("img").forEach(img=>{

            if(/^http/.test(img.src)===false) img.src = img.src.replace("file","https");
            if(JsonFile.img_base64[img.src]===undefined || JsonFile.img_base64[img.src]==="") return;

            img.src = JsonFile.img_base64[img.src];
        });


        document.querySelectorAll("a").forEach(a=>{
            a.setAttribute("target","_blank");
        });


        
        
    }
    function LoadJson(y_m){

        fetch(y_m).then(response => response.json()).then(data => {
        
            JsonFile = data;
            ShowPlurk();
        
        }).catch(error => {

            document.querySelector("#Plurk").innerHTML = `<div>無資料或出現錯誤</div>`;
            console.error(`Error:${error}`);
        });
    }
</script>
<body>

    <div id="Info"><a href="https://www.plurk.com/kfsshrimp4" target="_blank">https://www.plurk.com/kfsshrimp4</a><BR>噗浪備份系統<br>内含成人內容，未滿18歲禁止使用</div>
    <div id="FileBox">
        <select id="year" >
        </select>
        <select id="month"></select>
        <button id="submit">確定</button>
        <!--<input id="File" type="file"> <button>讀取</button>-->
    </div>

    <div id="Plurk"></div>
</body>